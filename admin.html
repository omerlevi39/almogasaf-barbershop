<!doctype html>
<html lang="he" dir="rtl">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>מנהל — Almog Asaf Barbershop</title>
    <link rel="stylesheet" href="css/style.css" />
    <!-- מינימום תוספות עיצוב – לא נוגעות ב-theme הכללי -->
    <style>
        .icon-btn {
            padding: 6px 10px;
            border-radius: 999px;
            border: 1px solid var(--border);
            background: rgba(255,92,168,.08);
            color: #fff;
            cursor: pointer;
            line-height: 1
        }

            .icon-btn.danger {
                border-color: #ff6a85
            }

            .icon-btn:hover {
                box-shadow: 0 0 0 3px rgba(255,92,168,.25)
            }

        .chip {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 6px 10px;
            border-radius: 999px;
            border: 1px solid var(--border);
            background: rgba(255,92,168,.08);
            color: #fff;
            cursor: pointer
        }

            .chip.off {
                opacity: .5;
                text-decoration: line-through
            }

        .grid-slots {
            display: flex;
            flex-wrap: wrap;
            gap: 8px
        }

        .btn.small {
            padding: 6px 10px
        }

        .muted2 {
            opacity: .85
        }

        .rowbar {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            align-items: center
        }

        /* פוסטים – מינימום סגנון, לא שובר כלום */
        .posts-wrap .post-item {
            border: 1px solid var(--border);
            border-radius: 12px;
            background: rgba(255,92,168,.06);
            margin: 10px 0;
            overflow: hidden
        }

        .posts-wrap .post-head {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 12px
        }

        .posts-wrap .media-frame {
            width: 100%;
            aspect-ratio: 16/9;
            background: #000;
            display: flex;
            align-items: center;
            justify-content: center
        }

            .posts-wrap .media-frame > img, .posts-wrap .media-frame > video {
                width: 100%;
                height: 100%;
                object-fit: contain;
                display: block;
                background: #000
            }

        .posts-wrap .caption {
            padding: 8px 12px
        }

        .posts-wrap .post-actions {
            display: flex;
            gap: 8px;
            padding: 8px 12px;
            border-top: 1px dashed var(--border)
        }

        .previewBox {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-top: 10px
        }

        .prevMedia {
            width: 360px;
            max-width: 100%;
            aspect-ratio: 16/9;
            object-fit: contain;
            border-radius: 12px;
            border: 1px solid var(--border);
            background: #000;
            display: none
        }

        .tab.locked {
            opacity: .45;
            pointer-events: none
        }
    </style>
</head>
<body>
    <div class="shell">
        <header class="nav">
            <div class="brand">ALMOG ASAF • BARBERSHOP</div>
            <nav class="tabs">
                <a class="tab" href="index.html">דף בית</a>
                <a class="tab" href="book.html">קביעת תור</a>
                <a class="tab" href="mine.html">התורים שלי</a>
                <a class="tab" href="cuts.html">My Haircuts ✌️</a>
                <a class="tab active" href="admin.html">מנהל</a>
            </nav>
        </header>

        <main>
            <section class="card section">
                <h2 style="margin-top:0">מנהל</h2>

                <!-- כניסה -->
                <div id="adminGate">
                    <label>סיסמה</label>
                    <input id="adminPass" type="password" inputmode="numeric" placeholder="1936" />
                    <div class="actions" style="margin-top:12px">
                        <button id="adminEnter" class="btn primary">כניסה</button>
                    </div>
                    <small class="muted2">* רמז: 1936</small>
                </div>

                <div id="adminPanel" style="display:none">
                    <!-- תאריך + ניהול שעות -->
                    <div class="form-grid">
                        <div>
                            <label>תאריך</label>
                            <input type="date" id="adDate" />
                            <small class="muted2">הפעל/כבה כל חצי שעה (00:00–23:30). ברירת מחדל: א׳–ה׳ 17:00–19:30</small>
                        </div>
                    </div>

                    <section class="card section" style="margin-top:12px">
                        <div class="rowbar">
                            <h3 style="margin:10px 0">ניהול שעות ליום</h3>
                            <button id="btnDefault" class="btn small">ברירת מחדל (17:00–19:30)</button>
                            <button id="btnClearAll" class="btn small">נקה הכל</button>
                            <button id="btnAllDay" class="btn small">כל היום</button>
                        </div>
                        <div id="manageSlots" class="grid-slots"></div>
                    </section>

                    <div class="calendar">
                        <h3 style="margin:10px 0">לוח תורים ליום</h3>
                        <div id="adminList" class="list"></div>
                    </div>

                    <hr style="border:none;border-top:1px solid var(--border);margin:16px 0" />

                    <!-- ייצוא + לקוח מצטיין -->
                    <section class="card section">
                        <h3 style="margin-top:0">ייצוא חודשי + לקוח מצטיין</h3>
                        <div class="form-grid">
                            <div>
                                <label>בחר/י חודש</label>
                                <input type="month" id="exMonth" />
                            </div>
                            <div style="display:flex;align-items:end;gap:8px">
                                <button id="btnExport" class="btn primary">ייצא CSV</button>
                                <button id="btnRafflePerk" class="btn">הגרל מצטיין + קוד</button>
                            </div>
                        </div>
                        <div id="exInfo" class="list" style="margin-top:12px"></div>
                    </section>

                    <hr style="border:none;border-top:1px solid var(--border);margin:16px 0" />

                    <!-- פוסטים (תוספת) -->
                    <section class="card section posts-wrap">
                        <h3 style="margin-top:0">פוסטים — My Haircuts ✌️</h3>
                        <div class="form-grid">
                            <div>
                                <label>בחר מדיה (תמונה/וידאו)</label>
                                <input type="file" id="postFile" accept="image/*,video/*" />
                            </div>
                            <div>
                                <label>כיתוב (אופציונלי)</label>
                                <input type="text" id="postCaption" placeholder="מה חדש במספרה?" />
                            </div>
                            <div style="display:flex;align-items:end;gap:8px">
                                <button id="btnUploadPost" class="btn primary">העלה פוסט</button>
                                <button id="btnClearPrev" class="btn">נקה תצוגה</button>
                                <span id="postMsg" class="muted2"></span>
                            </div>
                        </div>

                        <div class="previewBox">
                            <img id="prevImg" class="prevMedia" alt="תצוגה מקדימה" />
                            <video id="prevVid" class="prevMedia" muted playsinline controls></video>
                            <small class="muted2">תצוגה רחבה (16:9) · מציג את כל המדיה בשלמותה.</small>
                        </div>

                        <h4 style="margin:16px 0 6px">פוסטים אחרונים</h4>
                        <div id="adminPosts"></div>
                    </section>
                </div>
            </section>

            <footer>© Almog Asaf Barbershop</footer>
        </main>
    </div>

    <script src="js/db.js"></script>
    <script>
        /* ===== עזרי זמן/שעות ===== */
        function labelOfSlot(slot) { const t = slotToHM(slot); return `${String(t.h).padStart(2, '0')}:${String(t.m).padStart(2, '0')}`; }

        /* ===== כניסה ===== */
        const ADMIN_FLAG = 'admin_ok';
        function setConnectedUI(on) {
            document.getElementById('adminGate').style.display = on ? 'none' : 'block';
            document.getElementById('adminPanel').style.display = on ? 'block' : 'none';
        }
        function tryLogin() {
            const v = (document.getElementById('adminPass').value || '').replace(/\s+/g, '').trim();
            if (v === '1936') { sessionStorage.setItem(ADMIN_FLAG, '1'); setConnectedUI(true); renderAll(); initExportBlock(); initPostsBlock(); }
            else alert('סיסמה שגויה');
        }

        /* ===== ניהול שעות ===== */
        function renderManageSlots() {
            const dayKey = document.getElementById('adDate').value; if (!dayKey) return;
            const wrap = document.getElementById('manageSlots'); wrap.innerHTML = '';
            const allowed = new Set(getAllowedSlots(dayKey));
            for (let s = 0; s <= 47; s++) {
                const on = allowed.has(s);
                const btn = document.createElement('button');
                btn.className = 'chip' + (on ? '' : ' off');
                btn.textContent = labelOfSlot(s);
                btn.title = on ? 'זמין' : 'מכובה';
                btn.addEventListener('click', () => {
                    if (on) {
                        if (confirm(`להוריד את ${labelOfSlot(s)} ל-${dayKey}? אם יש תור הוא יבוטל.`)) {
                            disableSlotForDay(dayKey, s); renderAll();
                        }
                    } else {
                        enableSlotForDay(dayKey, s); renderAll();
                    }
                });
                wrap.appendChild(btn);
            }
        }
        function renderDayList() {
            const dayKey = document.getElementById('adDate').value; if (!dayKey) return;
            const list = getDayList(dayKey); const box = document.getElementById('adminList'); box.innerHTML = '';
            list.slice().sort((a, b) => sortByActual(a, b, list)).forEach(a => {
                const t = calcActualTime(a, list);
                const row = document.createElement('div');
                row.className = 'item';
                row.innerHTML = `
              <div><b>${formatHM(t.h, t.m)}</b> · ${a.firstName} ${a.lastName}
              · <span class="muted">${a.phone || 'ללא טלפון'}</span>
              · <span class="muted">${a.withScissors ? 'עם גזירות' : 'רגיל'}</span></div>
              <button class="icon-btn danger" data-slot="${a.baseSlot}">✖</button>`;
                box.appendChild(row);
            });
            if (!list.length) box.innerHTML = '<div class="muted">אין תורים ביום זה.</div>';
            box.querySelectorAll('.icon-btn[data-slot]').forEach(b => {
                b.addEventListener('click', () => {
                    const baseSlot = Number(b.getAttribute('data-slot'));
                    const timeLabel = b.parentElement.querySelector('b')?.textContent || '';
                    if (confirm(`לבטל את התור של ${timeLabel}?`)) {
                        if (removeAppointment(dayKey, baseSlot)) renderAll(); else alert('לא נמצא תור לביטול');
                    }
                });
            });
        }
        function renderAll() { renderManageSlots(); renderDayList(); }

        /* ===== כפתורי שעות מהירים ===== */
        function initHoursShortcuts() {
            const adDate = document.getElementById('adDate');
            document.getElementById('btnDefault').addEventListener('click', () => {
                const list = []; for (let s = hmToSlot(17, 0); s <= hmToSlot(19, 30); s++) list.push(s); setAllowedSlots(adDate.value, list); renderAll();
            });
            document.getElementById('btnClearAll').addEventListener('click', () => { setAllowedSlots(adDate.value, []); renderAll(); });
            document.getElementById('btnAllDay').addEventListener('click', () => { const all = [...Array(48).keys()]; setAllowedSlots(adDate.value, all); renderAll(); });
            adDate.addEventListener('change', renderAll);
            if (!adDate.value) adDate.value = new Date().toISOString().slice(0, 10);
        }

        /* ===== ייצוא + מצטיין ===== */
        function initExportBlock() {
            const exMonth = document.getElementById('exMonth'), info = document.getElementById('exInfo');
            const btnExport = document.getElementById('btnExport');
            const btnRaffle = document.getElementById('btnRafflePerk');

            if (!exMonth.value) { exMonth.value = new Date().toISOString().slice(0, 7); }

            function parse() { const [y, m] = exMonth.value.split('-').map(Number); return { year: y, month: m }; }
            function renderTop(y, m) {
                info.innerHTML = '';
                const { tops, max } = getTopClientsInMonth(y, m);
                if (!tops.length) { info.innerHTML = '<div class="muted">אין נתונים לחודש זה.</div>'; return; }
                const perk = getMonthlyTopPerk(y, m);
                const code = getMonthlyPerkCode(y, m);
                tops.forEach(({ row }) => {
                    const marked = perk && row.firstName.toLowerCase() === perk.firstName.toLowerCase() &&
                        row.lastName.toLowerCase() === perk.lastName.toLowerCase() &&
                        (row.phone || '') === (perk.phone || '');
                    const div = document.createElement('div'); div.className = 'item';
                    div.innerHTML = `<div><b>${row.firstName} ${row.lastName}</b> · <span class="muted">${row.phone || 'ללא טלפון'}</span> · ${max} ביקורים${marked ? ` · <span class="muted">מצטיין${code ? ` · קוד: ${code}` : ''}</span>` : ''}</div>`;
                    info.appendChild(div);
                });
            }

            btnExport.addEventListener('click', () => {
                const { year, month } = parse(); const csv = buildMonthlyCSV(year, month);
                const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' }); const url = URL.createObjectURL(blob);
                const a = document.createElement('a'); a.href = url; a.download = `appointments_${year}-${String(month).padStart(2, '0')}.csv`; a.click(); URL.revokeObjectURL(url);
                renderTop(year, month);
            });

            btnRaffle.addEventListener('click', () => {
                const { year, month } = parse(); const { tops } = getTopClientsInMonth(year, month);
                if (!tops.length) return alert('אין נתונים לחודש זה');
                const chosen = tops.length === 1 ? tops[0].row : tops[Math.floor(Math.random() * tops.length)].row;
                if (confirm(`להגדיר את ${chosen.firstName} ${chosen.lastName} כמצטיין החודש?`)) {
                    const code = setMonthlyTopPerkWithCode(year, month, { firstName: chosen.firstName, lastName: chosen.lastName, phone: chosen.phone || '' });
                    alert(`נבחר: ${chosen.firstName} ${chosen.lastName}\nקוד הנחה: ${code}`);
                    renderTop(year, month);
                }
            });

            const { year, month } = parse(); renderTop(year, month);
        }

        /* ===== פוסטים ===== */
        function initPostsBlock() {
            const file = document.getElementById('postFile');
            const cap = document.getElementById('postCaption');
            const btnUp = document.getElementById('btnUploadPost');
            const btnClr = document.getElementById('btnClearPrev');
            const msg = document.getElementById('postMsg');
            const pImg = document.getElementById('prevImg');
            const pVid = document.getElementById('prevVid');
            const list = document.getElementById('adminPosts');

            function clearPrev() { pImg.src = ''; pVid.src = ''; pImg.style.display = 'none'; pVid.style.display = 'none'; try { pVid.pause(); pVid.currentTime = 0; } catch { } }
            btnClr.addEventListener('click', clearPrev);

            file.addEventListener('change', () => {
                clearPrev();
                const f = file.files?.[0]; if (!f) return;
                const r = new FileReader();
                r.onload = () => {
                    if (f.type.startsWith('video/')) { pVid.src = r.result; pVid.style.display = 'block'; }
                    else { pImg.src = r.result; pImg.style.display = 'block'; }
                };
                r.readAsDataURL(f);
            });

            btnUp.addEventListener('click', () => {
                const f = file.files?.[0]; if (!f) return alert('בחר/י קובץ תמונה או וידאו');
                const mediaType = f.type.startsWith('video/') ? 'video' : 'image';
                const r = new FileReader();
                r.onload = () => {
                    addPostMedia(mediaType, r.result, cap.value || '');
                    cap.value = ''; file.value = ''; clearPrev(); msg.textContent = 'הועלה!';
                    setTimeout(() => msg.textContent = '', 1500);
                    renderPosts();
                };
                r.readAsDataURL(f);
            });

            function cardHTML(p) {
                const media = p.mediaType === 'video'
                    ? `<div class="media-frame"><video src="${p.src || p.dataURL}" playsinline controls></video></div>`
                    : `<div class="media-frame"><img src="${p.src || p.dataURL}" alt="post"/></div>`;
                const ts = new Date(p.ts || Date.now()).toLocaleString('he-IL', { year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit' });
                return `
              <div class="post-item" data-id="${p.id}">
                <div class="post-head"><div><b>פוסט</b></div><div class="muted2">${ts}</div></div>
                ${media}
                ${p.caption ? `<div class="caption">${p.caption}</div>` : ''}
                <div class="post-actions">
                  <button class="btn small dangerDel">מחק פוסט</button>
                </div>
              </div>`;
            }
            function renderPosts() {
                const arr = getPosts(); list.innerHTML = arr.length ? arr.map(cardHTML).join('') : '<div class="muted">אין פוסטים.</div>';
                list.querySelectorAll('.dangerDel').forEach(b => {
                    b.addEventListener('click', () => {
                        const id = b.closest('.post-item').getAttribute('data-id');
                        if (confirm('למחוק את הפוסט?')) { if (deletePost(id)) renderPosts(); else alert('תקלה במחיקה'); }
                    });
                });
            }
            renderPosts();
            window.addEventListener('storage', (e) => { if (e.key === DB_KEY || e.key === DB_KEY) renderPosts(); });
        }

        /* ===== אתחול כללי ===== */
        function init() {
            document.getElementById('adminEnter').addEventListener('click', tryLogin);
            document.getElementById('adminPass').addEventListener('keydown', e => { if (e.key === 'Enter') tryLogin(); });

            if (sessionStorage.getItem(ADMIN_FLAG) === '1') {
                setConnectedUI(true);
                if (!document.getElementById('adDate').value) document.getElementById('adDate').value = new Date().toISOString().slice(0, 10);
                renderAll(); initExportBlock(); initPostsBlock();
            } else {
                setConnectedUI(false);
                if (!document.getElementById('adDate').value) document.getElementById('adDate').value = new Date().toISOString().slice(0, 10);
            }
            initHoursShortcuts();

            // סנכרון שינויים
            window.addEventListener('storage', (ev) => { if (ev.key === DB_KEY) renderAll(); });
        }

        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
